{"version":3,"sources":["../src/node-manager.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\r\n * Node.js 版本管理器\r\n * \r\n * 提供 Node.js 版本检测、安装、切换等功能\r\n */\r\n\r\nimport { execa } from 'execa'\r\nimport fs from 'fs-extra'\r\nimport path from 'node:path'\r\nimport os from 'node:os'\r\nimport semver from 'semver'\r\nimport type {\r\n  NodeVersion,\r\n  InstalledNodeVersion,\r\n  NodeManagerConfig,\r\n  InstallOptions,\r\n  NodeEnvironment,\r\n} from './types'\r\n\r\n/**\r\n * Node.js 版本管理器类\r\n */\r\nexport class NodeManager {\r\n  private config: NodeManagerConfig\r\n\r\n  constructor(config: NodeManagerConfig = {}) {\r\n    this.config = {\r\n      installDir: config.installDir || path.join(os.homedir(), '.ldesign', 'node'),\r\n      mirror: config.mirror || 'https://nodejs.org/dist',\r\n      verbose: config.verbose ?? false,\r\n      ...config,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取当前 Node.js 环境信息\r\n   */\r\n  async getCurrentEnvironment(): Promise<NodeEnvironment> {\r\n    try {\r\n      const { stdout: nodeVersion } = await execa('node', ['--version'])\r\n      const { stdout: npmVersion } = await execa('npm', ['--version'])\r\n      const { stdout: nodePath } = await execa('which', ['node'], {\r\n        shell: true,\r\n      }).catch(() => execa('where', ['node'], { shell: true }))\r\n      const { stdout: npmPath } = await execa('which', ['npm'], {\r\n        shell: true,\r\n      }).catch(() => execa('where', ['npm'], { shell: true }))\r\n\r\n      return {\r\n        nodeVersion: nodeVersion.trim(),\r\n        npmVersion: npmVersion.trim(),\r\n        nodePath: nodePath.split('\\n')[0].trim(),\r\n        npmPath: npmPath.split('\\n')[0].trim(),\r\n        arch: process.arch,\r\n        platform: process.platform,\r\n      }\r\n    } catch (error) {\r\n      throw new Error(`Failed to get Node environment: ${error}`)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 解析版本字符串\r\n   */\r\n  parseVersion(versionStr: string): NodeVersion | null {\r\n    // 移除 'v' 前缀\r\n    const cleanVersion = versionStr.replace(/^v/, '')\r\n    const parsed = semver.parse(cleanVersion)\r\n\r\n    if (!parsed) {\r\n      return null\r\n    }\r\n\r\n    return {\r\n      version: `v${parsed.version}`,\r\n      major: parsed.major,\r\n      minor: parsed.minor,\r\n      patch: parsed.patch,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 比较版本\r\n   */\r\n  compareVersions(v1: string, v2: string): number {\r\n    const clean1 = v1.replace(/^v/, '')\r\n    const clean2 = v2.replace(/^v/, '')\r\n    return semver.compare(clean1, clean2)\r\n  }\r\n\r\n  /**\r\n   * 检查版本是否满足要求\r\n   */\r\n  satisfiesVersion(version: string, range: string): boolean {\r\n    const cleanVersion = version.replace(/^v/, '')\r\n    return semver.satisfies(cleanVersion, range)\r\n  }\r\n\r\n  /**\r\n   * 获取已安装的 Node 版本列表\r\n   */\r\n  async getInstalledVersions(): Promise<InstalledNodeVersion[]> {\r\n    try {\r\n      const installDir = this.config.installDir!\r\n      \r\n      if (!await fs.pathExists(installDir)) {\r\n        return []\r\n      }\r\n\r\n      const entries = await fs.readdir(installDir, { withFileTypes: true })\r\n      const versions: InstalledNodeVersion[] = []\r\n      const currentEnv = await this.getCurrentEnvironment().catch(() => null)\r\n\r\n      for (const entry of entries) {\r\n        if (entry.isDirectory() && entry.name.startsWith('v')) {\r\n          const versionInfo = this.parseVersion(entry.name)\r\n          if (versionInfo) {\r\n            const versionPath = path.join(installDir, entry.name)\r\n            const isCurrent = currentEnv?.nodeVersion === entry.name\r\n\r\n            versions.push({\r\n              ...versionInfo,\r\n              path: versionPath,\r\n              current: isCurrent,\r\n              default: false, // TODO: 实现默认版本检测\r\n            })\r\n          }\r\n        }\r\n      }\r\n\r\n      return versions.sort((a, b) => this.compareVersions(b.version, a.version))\r\n    } catch (error) {\r\n      if (this.config.verbose) {\r\n        console.error('Failed to get installed versions:', error)\r\n      }\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 检查版本是否已安装\r\n   */\r\n  async isVersionInstalled(version: string): Promise<boolean> {\r\n    const installedVersions = await this.getInstalledVersions()\r\n    return installedVersions.some(v => v.version === version)\r\n  }\r\n\r\n  /**\r\n   * 获取版本安装路径\r\n   */\r\n  getVersionPath(version: string): string {\r\n    return path.join(this.config.installDir!, version)\r\n  }\r\n\r\n  /**\r\n   * 验证 Node 安装\r\n   */\r\n  async validateInstallation(versionPath: string): Promise<boolean> {\r\n    try {\r\n      const binPath = process.platform === 'win32'\r\n        ? path.join(versionPath, 'node.exe')\r\n        : path.join(versionPath, 'bin', 'node')\r\n\r\n      if (!await fs.pathExists(binPath)) {\r\n        return false\r\n      }\r\n\r\n      // 尝试执行 node --version\r\n      const { stdout } = await execa(binPath, ['--version'])\r\n      return stdout.trim().startsWith('v')\r\n    } catch {\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 日志输出\r\n   */\r\n  private log(message: string): void {\r\n    if (this.config.verbose) {\r\n      console.log(`[NodeManager] ${message}`)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 错误日志\r\n   */\r\n  private error(message: string, error?: any): void {\r\n    console.error(`[NodeManager] ${message}`, error || '')\r\n  }\r\n}\r\n\r\n/**\r\n * 创建 Node 版本管理器实例\r\n */\r\nexport function createNodeManager(config?: NodeManagerConfig): NodeManager {\r\n  return new NodeManager(config)\r\n}\r\n\r\n/**\r\n * 获取当前 Node 版本\r\n */\r\nexport async function getCurrentNodeVersion(): Promise<string> {\r\n  try {\r\n    const { stdout } = await execa('node', ['--version'])\r\n    return stdout.trim()\r\n  } catch (error) {\r\n    throw new Error(`Failed to get Node version: ${error}`)\r\n  }\r\n}\r\n\r\n/**\r\n * 检查 Node 是否已安装\r\n */\r\nexport async function isNodeInstalled(): Promise<boolean> {\r\n  try {\r\n    await execa('node', ['--version'])\r\n    return true\r\n  } catch {\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * 获取推荐的 Node 版本\r\n */\r\nexport function getRecommendedNodeVersion(): string {\r\n  // 返回当前 LTS 版本\r\n  return '20' // Node.js 20 是当前 LTS\r\n}\r\n"]}